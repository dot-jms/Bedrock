<script>
(function() {
  'use strict';

  // ===== CONFIG =====
  const VALID_KEYS = ["BEDROCK2025", "TEST123", "DEMO42"];
  const COOKIE_NAME = "bedrock_access";

  // ===== ELEMENTS =====
  const keyInput = document.getElementById('keyInput');
  const accessBtn = document.getElementById('accessBtn');
  const loading = document.getElementById('loading');
  const successMsg = document.getElementById('successMsg');
  const errorMsg = document.getElementById('errorMsg');

  // ===== COOKIE FUNCTIONS =====
  function setCookie(name, value) {
    document.cookie = name + '=' + encodeURIComponent(value) + ';path=/;expires=Fri, 31 Dec 9999 23:59:59 GMT;SameSite=Strict';
  }

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
  }

  // ===== UI FUNCTIONS =====
  function hideMessages() {
    successMsg.classList.remove('show');
    errorMsg.classList.remove('show');
  }

  function showLoading(show) {
    loading.style.display = show ? 'flex' : 'none';
    accessBtn.disabled = show;
    if (show) hideMessages();
  }

  function showSuccess() {
    hideMessages();
    successMsg.classList.add('show');
  }

  function showError() {
    hideMessages();
    errorMsg.classList.add('show');
    setTimeout(() => {
      keyInput.value = '';
      keyInput.focus();
    }, 500);
  }

  // ===== LAUNCH BEDROCK =====
  function launchBedrock() {
    showSuccess();
    setCookie(COOKIE_NAME, 'granted');

    setTimeout(() => {
      const portal = window.open('portal.html', '_blank'); // <-- old working launch
      if (!portal || portal.closed) {
        alert("Popup blocked! Please allow popups for this site."); 
        return;
      }
    }, 1000); // wait 1 sec so user sees "Access granted"
  }

  // ===== KEY CHECK =====
  function checkKey() {
    const key = keyInput.value.trim();
    showLoading(true);

    setTimeout(() => { // simulate async auth
      showLoading(false);
      if (VALID_KEYS.includes(key)) {
        launchBedrock();
      } else {
        showError();
      }
    }, 500);
  }

  // ===== EVENT LISTENERS =====
  accessBtn.addEventListener('click', checkKey);
  keyInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') checkKey();
  });

  // ===== AUTO-LAUNCH IF COOKIE EXISTS =====
  window.addEventListener('DOMContentLoaded', () => {
    if (getCookie(COOKIE_NAME) === 'granted') {
      launchBedrock();
    }
  });
})();
</script>
